<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Text Only - lapillo</title>
    <link href="https://cdn.jsdelivr.net/npm/@shadcn/ui@latest/dist/tailwind.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="studio-lapillo.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-storage.js"></script>
    
    <!-- Firebase 설정 및 컴포넌트 시스템 -->
    <script src="js/firebase-cdn.js"></script>
    <script src="js/component-loader.js"></script>
    <script src="js/navigation-manager.js"></script>
    <script src="js/mobile-menu.js"></script>
</head>
<body class="bg-white font-sans">
    <!-- Header Component Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Text-Only Content Section -->
    <main class="py-6">
        <div class="project-detail-wrapper">
            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4"></div>
                <p class="text-gray-600">로딩 중...</p>
            </div>

            <!-- Text-Only Content (Hidden until loaded) -->
            <div id="text-content" class="hidden">
                <!-- Text Section - 2 Columns (제목 없음) -->
                <div class="project-text-section">
                    <!-- Left Column -->
                    <div class="project-text-left">
                        <div class="project-description">
                            <div id="korean-content"></div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="project-text-right">
                        <div class="project-description">
                            <div id="english-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-12 hidden">
                <div class="text-red-500 mb-4">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 18.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <p class="text-gray-600 mb-4">페이지를 찾을 수 없습니다.</p>
                <a href="index.html" class="inline-block px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 transition-colors">
                    홈으로 돌아가기
                </a>
            </div>
        </div>
    </main>

    <!-- Footer Component Placeholder -->
    <div id="footer-placeholder"></div>

    <script>
        // URL 파라미터 추출
        function getCategoryFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category');
        }
        function getIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Text-Only 컨텐츠 로드
        async function loadTextContent() {
            try {
                const id = getIdFromURL();
                const category = getCategoryFromURL();

                console.log('📝 Text-Only 페이지 로딩 시작 - id:', id, 'category:', category);

                // Firebase 서비스 대기
                let retryCount = 0;
                while (!window.firebaseService && retryCount < 10) {
                    console.log(`⏳ Firebase 서비스 대기 중... (${retryCount + 1}/10)`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }

                if (!window.firebaseService) {
                    throw new Error('Firebase 서비스를 초기화할 수 없습니다.');
                }

                let content = null;
                if (id) {
                    // id가 지정된 경우 해당 문서 로드
                    content = await window.firebaseService.getPortfolioById(id);
                    if (!content || !content.textOnly) {
                        throw new Error('유효한 Text-Only 컨텐츠가 아닙니다.');
                    }
                } else if (category) {
                    // 카테고리만 지정된 경우 해당 카테고리의 최신 Text-Only 문서 사용
                    const portfolios = await window.firebaseService.getPortfoliosByCategory(category);
                    const textOnlyPortfolios = portfolios.filter(p => p.textOnly);
                    console.log('📝 로드된 Text-Only 포트폴리오:', textOnlyPortfolios.length, '개');
                    if (textOnlyPortfolios.length === 0) {
                        throw new Error('해당 카테고리의 Text-Only 컨텐츠가 없습니다.');
                    }
                    content = textOnlyPortfolios[0];
                } else {
                    throw new Error('id 또는 category 파라미터가 필요합니다.');
                }
                
                // 페이지 제목 설정
                const pageTitle = content.koreanTitle || content.englishTitle || content.title || 'Text Only';
                document.getElementById('page-title').textContent = `${pageTitle} - lapillo`;

                // 좌/우 내용 분리 사용. 없으면 좌측 내용을 우측에 복제
                const leftContentRaw = content.textLeft || content.description || content.koreanDescription || '';
                const rightContentRaw = content.textRight || leftContentRaw;
                const koreanContent = leftContentRaw;
                // 단일 줄바꿈도 반영되도록 처리 (\n -> <br>)
                const koreanParagraphs = koreanContent
                    .split('\n\n')
                    .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`) 
                    .join('');
                document.getElementById('korean-content').innerHTML = koreanParagraphs;

                // 우측 컬럼
                const englishContent = rightContentRaw;
                const englishParagraphs = englishContent
                    .split('\n\n')
                    .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`) 
                    .join('');
                document.getElementById('english-content').innerHTML = englishParagraphs;

                // 로딩 숨기고 컨텐츠 표시
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('text-content').classList.remove('hidden');

                console.log('✅ Text-Only 컨텐츠 로딩 완료');

            } catch (error) {
                console.error('❌ Text-Only 컨텐츠 로드 에러:', error);
                
                // 로딩 숨기고 에러 상태 표시
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
            }
        }

        // 모바일 메뉴 상태 관리
        let mobileMenuOpen = false;

        // 동적 메뉴 스타일 계산
        function calculateDynamicMenuStyles() {
            const header = document.querySelector('header');
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            if (header) {
                const headerHeight = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
            }

            const availableHeight = viewportHeight - (header ? header.offsetHeight : 80);
            
            // 메뉴 간격 계산 (80%로 줄임)
            const menuGap = Math.max(0.6, Math.min(1.2, availableHeight * 0.08 / 16 * 0.8));
            document.documentElement.style.setProperty('--menu-gap', menuGap + 'rem');
            
            // 폰트 크기 계산 (현재의 90% → 추가 90% = 81%)
            const fontSize = Math.max(1.4, Math.min(2.2, viewportWidth * 0.045 * 0.81));
            document.documentElement.style.setProperty('--menu-font-size', fontSize + 'rem');
        }

        // 모바일 메뉴 토글
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            
            if (!mobileMenu || !hamburgerBtn) {
                console.error('❌ Elements not found');
                return;
            }
            
            mobileMenuOpen = !mobileMenuOpen;
            
            if (mobileMenuOpen) {
                // 메뉴 열기
                calculateDynamicMenuStyles();
                mobileMenu.style.display = 'block';
                mobileMenu.classList.add('show');
                hamburgerBtn.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                console.log('✅ Mobile menu opened');
            } else {
                // 메뉴 닫기
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                setTimeout(() => {
                    if (!mobileMenuOpen) {
                        mobileMenu.style.display = 'none';
                    }
                }, 300);
                
                console.log('✅ Mobile menu closed');
            }
        }

        // 모바일 메뉴 초기화
        function initMobileMenu() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleMobileMenu);
                console.log('✅ Hamburger button initialized');
            } else {
                console.error('❌ Hamburger button not found');
            }

            if (mobileMenu) {
                console.log('✅ Mobile menu found');
            } else {
                console.error('❌ Mobile menu not found');
            }

            // 메뉴 링크 클릭 시 닫기
            const mobileNav = document.getElementById('mobile-navigation');
            if (mobileNav) {
                mobileNav.addEventListener('click', (e) => {
                    if (e.target.tagName === 'A') {
                        toggleMobileMenu();
                    }
                });
            }

            // 화면 크기 변경 시 동적 스타일 재계산 및 모바일 메뉴 자동 닫기
            window.addEventListener('resize', () => {
                if (mobileMenuOpen) {
                    // 768px을 넘어가면 모바일 메뉴 자동 닫기
                    if (window.innerWidth > 768) {
                        toggleMobileMenu();
                    } else {
                        calculateDynamicMenuStyles();
                    }
                }
            });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('📝 Text-Only 페이지 초기화 시작...');

            // 컴포넌트 로딩
            console.log('🔄 컴포넌트 로딩 시작...');
            await loadComponent('header-placeholder', 'components/header.html');
            await loadComponent('footer-placeholder', 'components/footer.html');
            console.log('✅ 컴포넌트 로딩 완료');

            // 모바일 메뉴 초기화
            initMobileMenu();

            // NavigationManager 초기화 및 업데이트
            if (window.navigationManager) {
                const id = getIdFromURL();
                let category = getCategoryFromURL();
                // id로 접근 시에는 로드 후 세팅되므로 임시로 현재값 유지
                window.navigationManager.currentPage = category || window.navigationManager.currentPage;
                await window.navigationManager.updateNavigation();
                
                // Text-Only 페이지에서는 해당 카테고리 메뉴를 활성화
                if (category) window.navigationManager.setActiveMenu(category);
                console.log('✅ 네비게이션 업데이트 완료');
            } else {
                console.warn('⚠️ NavigationManager가 없습니다');
            }

            // Text-Only 컨텐츠 로드
            await loadTextContent();
            
            console.log('✅ Text-Only 페이지 초기화 완료');
        });
    </script>
</body>
</html>
