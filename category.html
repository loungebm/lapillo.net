<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category - lapillo</title>
    <link href="https://cdn.jsdelivr.net/npm/@shadcn/ui@latest/dist/tailwind.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="studio-lapillo.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-storage.js"></script>
    
    <!-- Firebase μ„¤μ • λ° μ»΄ν¬λ„νΈ μ‹μ¤ν… -->
    <script src="js/firebase-cdn.js"></script>
    <script src="js/component-loader.js"></script>
    <script src="js/navigation-manager.js"></script>
</head>
<body class="bg-white font-sans">
    <!-- Header Component Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Portfolio Grid Section -->
    <main class="py-6">
        <div class="portfolio-grid-wrapper">
            <div class="portfolio-grid collection-content-wrapper" id="gridThumbs">
                
                <!-- Firebaseμ—μ„ λ΅λ“ν•  λ•κΉμ§€ λ΅λ”© ν‘μ‹ -->
                <div id="loading" class="col-span-full text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4"></div>
                    <p class="text-gray-600">ν¬νΈν΄λ¦¬μ¤ λ΅λ”© μ¤‘...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Component Placeholder -->
    <div id="footer-placeholder"></div>

    <script>
        // URLμ—μ„ μΉ΄ν…κ³ λ¦¬ ID μ¶”μ¶
        function getCategoryIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category');
        }

        // μΉ΄ν…κ³ λ¦¬λ³„ ν¬νΈν΄λ¦¬μ¤ λ΅λ“ ν•¨μ
        async function loadCategoryPortfolios(categoryId) {
            try {
                console.log(`π¨ ${categoryId} μΉ΄ν…κ³ λ¦¬ ν¬νΈν΄λ¦¬μ¤ λ΅λ”© μ‹μ‘...`);
                
                // Firebase μ„λΉ„μ¤ λ€κΈ°
                let retryCount = 0;
                while (!window.firebaseService && retryCount < 10) {
                    console.log(`β³ Firebase μ„λΉ„μ¤ λ€κΈ° μ¤‘... (${retryCount + 1}/10)`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }
                
                if (!window.firebaseService) {
                    throw new Error('Firebase μ„λΉ„μ¤λ¥Ό μ΄κΈ°ν™”ν•  μ μ—†μµλ‹λ‹¤.');
                }
                
                // FirebaseServiceλ¥Ό ν†µν• ν¬νΈν΄λ¦¬μ¤ λ΅λ“
                const allPortfolios = await window.firebaseService.getAllPortfolios();
                console.log(`π“¦ μ „μ²΄ ν¬νΈν΄λ¦¬μ¤:`, allPortfolios.length, 'κ°');
                console.log(`π” μΉ΄ν…κ³ λ¦¬λ³„ λ¶„ν¬:`, allPortfolios.reduce((acc, p) => {
                    const cat = p.category || 'design';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, {}));
                
                const filteredPortfolios = allPortfolios.filter(p => 
                    (p.category || 'design') === categoryId
                );
                
                console.log(`β… λ΅λ“λ ${categoryId} ν¬νΈν΄λ¦¬μ¤:`, filteredPortfolios.length, 'κ°');
                console.log(`π― μ”μ²­ν• μΉ΄ν…κ³ λ¦¬ ID: "${categoryId}"`);
                
                // μ²« λ²μ§Έ ν¬νΈν΄λ¦¬μ¤μ μΉ΄ν…κ³ λ¦¬ μ •λ³΄ ν™•μΈ
                if (allPortfolios.length > 0) {
                    console.log(`π“„ μ²« λ²μ§Έ ν¬νΈν΄λ¦¬μ¤ μΉ΄ν…κ³ λ¦¬:`, allPortfolios[0].category);
                }
                
                // λ΅λ”© μ¨κΈ°κΈ°
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                // ν¬νΈν΄λ¦¬μ¤ λ λ”λ§
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = ''; // κΈ°μ΅΄ λ‚΄μ© μ΄κΈ°ν™”
                    
                    if (filteredPortfolios.length > 0) {
                        filteredPortfolios.forEach(portfolio => {
                            const gridItem = document.createElement('a');
                            gridItem.className = 'grid-item';
                            gridItem.href = `portfolio-detail.html?id=${portfolio.id}`;
                            
                            gridItem.innerHTML = `
                                <div class="grid-image">
                                    <div class="grid-image-inner-wrapper">
                                        <img src="${portfolio.thumbnail || './img/placeholder.jpg'}" 
                                             alt="${portfolio.englishTitle || portfolio.title || 'Portfolio'}" 
                                             class="portfolio-image"
                                             onerror="this.src='./img/placeholder.jpg'">
                                    </div>
                                </div>
                                <div class="portfolio-text">
                                    <h3 class="portfolio-title">${portfolio.englishTitle || portfolio.title || 'Untitled'}</h3>
                                </div>
                            `;
                            
                            gridContainer.appendChild(gridItem);
                        });
                        console.log(`β… ${categoryId} ν¬νΈν΄λ¦¬μ¤ λ λ”λ§ μ™„λ£`);
                    } else {
                        gridContainer.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <p class="text-gray-500">${categoryId} μΉ΄ν…κ³ λ¦¬μ— ν¬νΈν΄λ¦¬μ¤κ°€ μ—†μµλ‹λ‹¤.</p>
                            </div>
                        `;
                        console.log(`β οΈ ${categoryId} ν¬νΈν΄λ¦¬μ¤ μ—†μ`);
                    }
                }
                
            } catch (error) {
                console.error(`β ${categoryId} ν¬νΈν΄λ¦¬μ¤ λ΅λ“ μ—λ¬:`, error);
                
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = `
                        <div class="text-center text-red-500 py-12">
                            <p>${categoryId} ν¬νΈν΄λ¦¬μ¤ λ΅λ”©μ— μ‹¤ν¨ν–μµλ‹λ‹¤.</p>
                            <p class="text-sm mt-2">μ¤λ¥: ${error.message}</p>
                            <button onclick="loadCategoryPortfolios('${categoryId}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                λ‹¤μ‹ μ‹λ„
                            </button>
                        </div>
                    `;
                }
            }
        }

        // νμ΄μ§€ λ΅λ“ μ‹ μ»΄ν¬λ„νΈ λ΅λ“ λ° ν¬νΈν΄λ¦¬μ¤ λ΅λ“
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('π¨ μΉ΄ν…κ³ λ¦¬ νμ΄μ§€ μ΄κΈ°ν™” μ‹μ‘...');
            console.log('π“¦ Firebase μƒνƒ:', !!window.firebase);
            console.log('π”§ FirebaseService μƒνƒ:', !!window.firebaseService);
            console.log('π§­ NavigationManager μƒνƒ:', !!window.navigationManager);

            console.log('π”„ μ»΄ν¬λ„νΈ λ΅λ”© μ‹μ‘...');
            await loadComponent('header-placeholder', 'components/header.html');
            await loadComponent('footer-placeholder', 'components/footer.html');
            console.log('β… μ»΄ν¬λ„νΈ λ΅λ”© μ™„λ£');

            const categoryId = getCategoryIdFromUrl() || 'design'; // κΈ°λ³Έκ°’ 'design'
            document.title = `${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)} - lapillo`; // νμ΄μ§€ νƒ€μ΄ν‹€ μ—…λ°μ΄νΈ

            // NavigationManager μ΄κΈ°ν™” λ° μ—…λ°μ΄νΈ
            if (window.navigationManager) {
                window.navigationManager.currentPage = categoryId; // ν„μ¬ νμ΄μ§€ μ„¤μ •
                await window.navigationManager.updateNavigation();
                window.navigationManager.setActiveMenu(categoryId); // ν„μ¬ μΉ΄ν…κ³ λ¦¬ λ©”λ‰΄ ν™μ„±ν™”
                console.log('β… λ„¤λΉ„κ²μ΄μ… μ—…λ°μ΄νΈ μ™„λ£');
            } else {
                console.warn('β οΈ NavigationManagerκ°€ μ—†μµλ‹λ‹¤');
            }

            await loadCategoryPortfolios(categoryId);
            console.log('β… μΉ΄ν…κ³ λ¦¬ νμ΄μ§€ μ΄κΈ°ν™” μ™„λ£');
        });
    </script>
</body>
</html>