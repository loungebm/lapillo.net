<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category - lapillo</title>
    <link href="https://cdn.jsdelivr.net/npm/@shadcn/ui@latest/dist/tailwind.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="studio-lapillo.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-storage.js"></script>
    
    <!-- Firebase 설정 및 컴포넌트 시스템 -->
    <script src="js/firebase-cdn.js"></script>
    <script src="js/component-loader.js"></script>
    <script src="js/navigation-manager.js"></script>
</head>
<body class="bg-white font-sans">
    <!-- Header Component Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Portfolio Grid Section -->
    <main class="py-6">
        <div class="portfolio-grid-wrapper">
            <div class="portfolio-grid collection-content-wrapper" id="gridThumbs">
                
                <!-- Firebase에서 로드할 때까지 로딩 표시 -->
                <div id="loading" class="col-span-full text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4"></div>
                    <p class="text-gray-600">포트폴리오 로딩 중...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Component Placeholder -->
    <div id="footer-placeholder"></div>

    <script>
        // URL에서 카테고리 ID 추출
        function getCategoryIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category');
        }

        // 카테고리별 포트폴리오 로드 함수
        async function loadCategoryPortfolios(categoryId) {
            try {
                console.log(`🎨 ${categoryId} 카테고리 포트폴리오 로딩 시작...`);
                
                // Firebase 서비스 대기
                let retryCount = 0;
                while (!window.firebaseService && retryCount < 10) {
                    console.log(`⏳ Firebase 서비스 대기 중... (${retryCount + 1}/10)`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }
                
                if (!window.firebaseService) {
                    throw new Error('Firebase 서비스를 초기화할 수 없습니다.');
                }
                
                // FirebaseService를 통한 포트폴리오 로드
                const allPortfolios = await window.firebaseService.getAllPortfolios();
                console.log(`📦 전체 포트폴리오:`, allPortfolios.length, '개');
                console.log(`🔍 카테고리별 분포:`, allPortfolios.reduce((acc, p) => {
                    const cat = p.category || 'design';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, {}));
                
                const filteredPortfolios = allPortfolios.filter(p => 
                    (p.category || 'design') === categoryId
                );
                
                console.log(`✅ 로드된 ${categoryId} 포트폴리오:`, filteredPortfolios.length, '개');
                console.log(`🎯 요청한 카테고리 ID: "${categoryId}"`);
                
                // 첫 번째 포트폴리오의 카테고리 정보 확인
                if (allPortfolios.length > 0) {
                    console.log(`📄 첫 번째 포트폴리오 카테고리:`, allPortfolios[0].category);
                }
                
                // 로딩 숨기기
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                // 포트폴리오 렌더링
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = ''; // 기존 내용 초기화
                    
                    if (filteredPortfolios.length > 0) {
                        filteredPortfolios.forEach(portfolio => {
                            const gridItem = document.createElement('a');
                            gridItem.className = 'grid-item';
                            gridItem.href = `portfolio-detail.html?id=${portfolio.id}`;
                            
                            gridItem.innerHTML = `
                                <div class="grid-image">
                                    <div class="grid-image-inner-wrapper">
                                        <img src="${portfolio.thumbnail || './img/placeholder.jpg'}" 
                                             alt="${portfolio.englishTitle || portfolio.title || 'Portfolio'}" 
                                             class="portfolio-image"
                                             onerror="this.src='./img/placeholder.jpg'">
                                    </div>
                                </div>
                                <div class="portfolio-text">
                                    <h3 class="portfolio-title">${portfolio.englishTitle || portfolio.title || 'Untitled'}</h3>
                                </div>
                            `;
                            
                            gridContainer.appendChild(gridItem);
                        });
                        console.log(`✅ ${categoryId} 포트폴리오 렌더링 완료`);
                    } else {
                        gridContainer.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <p class="text-gray-500">${categoryId} 카테고리에 포트폴리오가 없습니다.</p>
                            </div>
                        `;
                        console.log(`⚠️ ${categoryId} 포트폴리오 없음`);
                    }
                }
                
            } catch (error) {
                console.error(`❌ ${categoryId} 포트폴리오 로드 에러:`, error);
                
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = `
                        <div class="text-center text-red-500 py-12">
                            <p>${categoryId} 포트폴리오 로딩에 실패했습니다.</p>
                            <p class="text-sm mt-2">오류: ${error.message}</p>
                            <button onclick="loadCategoryPortfolios('${categoryId}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                다시 시도
                            </button>
                        </div>
                    `;
                }
            }
        }

        // 모바일 메뉴 상태 관리
        let mobileMenuOpen = false;

        // 동적 메뉴 스타일 계산
        function calculateDynamicMenuStyles() {
            const header = document.querySelector('header');
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;

            if (header) {
                const headerHeight = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', headerHeight + 'px');
            }

            const availableHeight = viewportHeight - (header ? header.offsetHeight : 80);
            
            // 메뉴 간격 계산 (80%로 줄임)
            const menuGap = Math.max(0.6, Math.min(1.2, availableHeight * 0.08 / 16 * 0.8));
            document.documentElement.style.setProperty('--menu-gap', menuGap + 'rem');
            
            // 폰트 크기 계산 (90%로 줄임)
            const fontSize = Math.max(1.4, Math.min(2.2, viewportWidth * 0.045 * 0.9));
            document.documentElement.style.setProperty('--menu-font-size', fontSize + 'rem');
        }

        // 모바일 메뉴 토글
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            
            if (!mobileMenu || !hamburgerBtn) {
                console.error('❌ Elements not found');
                return;
            }
            
            mobileMenuOpen = !mobileMenuOpen;
            
            if (mobileMenuOpen) {
                // 메뉴 열기
                calculateDynamicMenuStyles();
                mobileMenu.style.display = 'block';
                mobileMenu.classList.add('show');
                hamburgerBtn.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                console.log('✅ Mobile menu opened');
            } else {
                // 메뉴 닫기
                mobileMenu.classList.remove('show');
                hamburgerBtn.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                setTimeout(() => {
                    if (!mobileMenuOpen) {
                        mobileMenu.style.display = 'none';
                    }
                }, 300);
                
                console.log('✅ Mobile menu closed');
            }
        }

        // 모바일 메뉴 초기화
        function initMobileMenu() {
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', toggleMobileMenu);
                console.log('✅ Hamburger button initialized');
            } else {
                console.error('❌ Hamburger button not found');
            }

            if (mobileMenu) {
                console.log('✅ Mobile menu found');
            } else {
                console.error('❌ Mobile menu not found');
            }

            // 메뉴 링크 클릭 시 닫기
            const mobileNav = document.getElementById('mobile-navigation');
            if (mobileNav) {
                mobileNav.addEventListener('click', (e) => {
                    if (e.target.tagName === 'A') {
                        toggleMobileMenu();
                    }
                });
            }

            // 화면 크기 변경 시 동적 스타일 재계산 및 모바일 메뉴 자동 닫기
            window.addEventListener('resize', () => {
                if (mobileMenuOpen) {
                    // 768px을 넘어가면 모바일 메뉴 자동 닫기
                    if (window.innerWidth > 768) {
                        toggleMobileMenu();
                    } else {
                        calculateDynamicMenuStyles();
                    }
                }
            });
        }

        // 페이지 로드 시 컴포넌트 로드 및 포트폴리오 로드
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🎨 카테고리 페이지 초기화 시작...');
            console.log('📦 Firebase 상태:', !!window.firebase);
            console.log('🔧 FirebaseService 상태:', !!window.firebaseService);
            console.log('🧭 NavigationManager 상태:', !!window.navigationManager);

            console.log('🔄 컴포넌트 로딩 시작...');
            await loadComponent('header-placeholder', 'components/header.html');
            await loadComponent('footer-placeholder', 'components/footer.html');
            console.log('✅ 컴포넌트 로딩 완료');

            // 모바일 메뉴 초기화
            initMobileMenu();

            const categoryId = getCategoryIdFromUrl() || 'design'; // 기본값 'design'
            document.title = `${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)} - lapillo`; // 페이지 타이틀 업데이트

            // NavigationManager 초기화 및 업데이트
            if (window.navigationManager) {
                window.navigationManager.currentPage = categoryId; // 현재 페이지 설정
                await window.navigationManager.updateNavigation();
                window.navigationManager.setActiveMenu(categoryId); // 현재 카테고리 메뉴 활성화
                console.log('✅ 네비게이션 업데이트 완료');
            } else {
                console.warn('⚠️ NavigationManager가 없습니다');
            }

            await loadCategoryPortfolios(categoryId);
            console.log('✅ 카테고리 페이지 초기화 완료');
        });
    </script>
</body>
</html>