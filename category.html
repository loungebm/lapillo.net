<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category - lapillo</title>
    <link href="https://cdn.jsdelivr.net/npm/@shadcn/ui@latest/dist/tailwind.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="studio-lapillo.css">
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat-storage.js"></script>
    
    <!-- Firebase ì„¤ì • ë° ì»´í¬ë„ŒíŠ¸ ì‹œìŠ¤í…œ -->
    <script src="js/firebase-cdn.js"></script>
    <script src="js/component-loader.js"></script>
    <script src="js/navigation-manager.js"></script>
</head>
<body class="bg-white font-sans">
    <!-- Header Component Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Portfolio Grid Section -->
    <main class="py-6">
        <div class="portfolio-grid-wrapper">
            <div class="portfolio-grid collection-content-wrapper" id="gridThumbs">
                
                <!-- Firebaseì—ì„œ ë¡œë“œí•  ë•Œê¹Œì§€ ë¡œë”© í‘œì‹œ -->
                <div id="loading" class="col-span-full text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4"></div>
                    <p class="text-gray-600">í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Component Placeholder -->
    <div id="footer-placeholder"></div>

    <script>
        // URLì—ì„œ ì¹´í…Œê³ ë¦¬ ID ì¶”ì¶œ
        function getCategoryIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('category');
        }

        // ì¹´í…Œê³ ë¦¬ë³„ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ í•¨ìˆ˜
        async function loadCategoryPortfolios(categoryId) {
            try {
                console.log(`ğŸ¨ ${categoryId} ì¹´í…Œê³ ë¦¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë”© ì‹œì‘...`);
                
                // Firebase ì„œë¹„ìŠ¤ ëŒ€ê¸°
                let retryCount = 0;
                while (!window.firebaseService && retryCount < 10) {
                    console.log(`â³ Firebase ì„œë¹„ìŠ¤ ëŒ€ê¸° ì¤‘... (${retryCount + 1}/10)`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retryCount++;
                }
                
                if (!window.firebaseService) {
                    throw new Error('Firebase ì„œë¹„ìŠ¤ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // FirebaseServiceë¥¼ í†µí•œ í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ
                const allPortfolios = await window.firebaseService.getAllPortfolios();
                const filteredPortfolios = allPortfolios.filter(p => 
                    (p.category || 'design') === categoryId
                );
                
                console.log(`âœ… ë¡œë“œëœ ${categoryId} í¬íŠ¸í´ë¦¬ì˜¤:`, filteredPortfolios.length, 'ê°œ');
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                // í¬íŠ¸í´ë¦¬ì˜¤ ë Œë”ë§
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
                    
                    if (filteredPortfolios.length > 0) {
                        filteredPortfolios.forEach(portfolio => {
                            const gridItem = document.createElement('a');
                            gridItem.className = 'grid-item';
                            gridItem.href = `portfolio-detail.html?id=${portfolio.id}`;
                            
                            gridItem.innerHTML = `
                                <div class="grid-image">
                                    <div class="grid-image-inner-wrapper">
                                        <img src="${portfolio.thumbnail || './img/placeholder.jpg'}" 
                                             alt="${portfolio.englishTitle || portfolio.title || 'Portfolio'}" 
                                             class="portfolio-image"
                                             onerror="this.src='./img/placeholder.jpg'">
                                    </div>
                                </div>
                                <div class="portfolio-text">
                                    <h3 class="portfolio-title">${portfolio.englishTitle || portfolio.title || 'Untitled'}</h3>
                                </div>
                            `;
                            
                            gridContainer.appendChild(gridItem);
                        });
                        console.log(`âœ… ${categoryId} í¬íŠ¸í´ë¦¬ì˜¤ ë Œë”ë§ ì™„ë£Œ`);
                    } else {
                        gridContainer.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <p class="text-gray-500">${categoryId} ì¹´í…Œê³ ë¦¬ì— í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                        console.log(`âš ï¸ ${categoryId} í¬íŠ¸í´ë¦¬ì˜¤ ì—†ìŒ`);
                    }
                }
                
            } catch (error) {
                console.error(`âŒ ${categoryId} í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ ì—ëŸ¬:`, error);
                
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                const gridContainer = document.getElementById('gridThumbs');
                if (gridContainer) {
                    gridContainer.innerHTML = `
                        <div class="text-center text-red-500 py-12">
                            <p>${categoryId} í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm mt-2">ì˜¤ë¥˜: ${error.message}</p>
                            <button onclick="loadCategoryPortfolios('${categoryId}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                ë‹¤ì‹œ ì‹œë„
                            </button>
                        </div>
                    `;
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì»´í¬ë„ŒíŠ¸ ë¡œë“œ ë° í¬íŠ¸í´ë¦¬ì˜¤ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ¨ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');
            console.log('ğŸ“¦ Firebase ìƒíƒœ:', !!window.firebase);
            console.log('ğŸ”§ FirebaseService ìƒíƒœ:', !!window.firebaseService);
            console.log('ğŸ§­ NavigationManager ìƒíƒœ:', !!window.navigationManager);

            console.log('ğŸ”„ ì»´í¬ë„ŒíŠ¸ ë¡œë”© ì‹œì‘...');
            await loadComponent('header-placeholder', 'components/header.html');
            await loadComponent('footer-placeholder', 'components/footer.html');
            console.log('âœ… ì»´í¬ë„ŒíŠ¸ ë¡œë”© ì™„ë£Œ');

            const categoryId = getCategoryIdFromUrl() || 'design'; // ê¸°ë³¸ê°’ 'design'
            document.title = `${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)} - lapillo`; // í˜ì´ì§€ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸

            // NavigationManager ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
            if (window.navigationManager) {
                window.navigationManager.currentPage = categoryId; // í˜„ì¬ í˜ì´ì§€ ì„¤ì •
                await window.navigationManager.updateNavigation();
                window.navigationManager.setActiveMenu(categoryId); // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë©”ë‰´ í™œì„±í™”
                console.log('âœ… ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } else {
                console.warn('âš ï¸ NavigationManagerê°€ ì—†ìŠµë‹ˆë‹¤');
            }

            await loadCategoryPortfolios(categoryId);
            console.log('âœ… ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        });
    </script>
</body>
</html>